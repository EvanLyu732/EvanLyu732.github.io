<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js" onload="renderMathInElement(document.body);"></script>


    
        <link rel="alternate" type="application/rss+xml" title="RSS" href="https://evanlyu732.github.io/atom.xml">
    
    
    
        
    
    
    
    
    
    
        
    
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <title>evan lyu</title>
    <meta charset="utf-8">
    <meta name="title" content="evan lyu">
    <meta name="description" content="">
    <meta property="og:image:width" content="200" />
    <meta property="og:image:height" content="200" />
    <link rel="stylesheet" href="https:&#x2F;&#x2F;evanlyu732.github.io/style.css">
    
    
    <style>
    @media screen and (min-width: 320px) {
        body {
            font-size: calc(16px + 2 * ((100vw - 320px) / 960));
        }
    }
    </style>
    
    <link rel="stylesheet" href="https://fonts.loli.net/css2?family=Source+Serif+Pro:wght@400;700&display=swap">
    <link rel="stylesheet" href="https://fonts.loli.net/css2?family=Noto+Serif+SC:wght@400;700&display=swap">
    <style>body { font-family: 'Source Serif Pro', 'Source Han Serif SC', 'Noto Serif CJK SC', 'Noto Serif SC', serif }</style>
    
</head>
<body>
    
    <header class="header">
        <div class="blog-title"><a href="https:&#x2F;&#x2F;evanlyu732.github.io" class="logo">evan lyu</a></div>
        <nav class="navbar">
    <ul class="menu">
        
        
        <li class="menu-item">
            
            
            
            
            <a href="https:&#x2F;&#x2F;evanlyu732.github.io&#x2F;" class="current-menu-item-link">主页</a>
            
        </li>
        
        <li class="menu-item">
            
            
            
            
            <a href="https:&#x2F;&#x2F;evanlyu732.github.io&#x2F;archives" class="menu-item-link">归档</a>
            
        </li>
        
        <li class="menu-item">
            
            
            
            
            <a href="https:&#x2F;&#x2F;evanlyu732.github.io&#x2F;about" class="menu-item-link">关于</a>
            
        </li>
        
        <li class="menu-item">
            
            
            
            
            <a href="https:&#x2F;&#x2F;evanlyu732.github.io&#x2F;note" class="menu-item-link">书架</a>
            
        </li>
        
        <li class="menu-item">
            
            
            
            
            <a href="https:&#x2F;&#x2F;evanlyu732.github.io&#x2F;atom.xml" class="menu-item-link">订阅</a>
            
        </li>
        
    </ul>
</nav>

    </header>
    
    <main class="main">
        
<section class="posts">
    
    <article class="post">
        <div class="post-title"><a href="https:&#x2F;&#x2F;evanlyu732.github.io&#x2F;blog4&#x2F;" class="post-title-link">记录一次对v4l2相机驱动的系统优化</a></div>
        <div class="post-content">
            
                <h1 id="bei-jing">背景</h1>
<p>最近有个需求需要重新优化供应商提供的相机驱动的代码, 来实现更低的cpu占用率以及更好的实时性. 同时要发布的消息里的时间戳是相机曝光时间戳并且是以unix时间戳为基准. 平台为Jetson Orin. 需要做localhost ipc来让下游应用使用. 相机原始默认编码是yuyv, 需要转换成bgr发送.</p>
<p>之前从来没做过linux驱动之类的开发, 也没研究过图像转码, 有因为别的需求看过旧版相机代码. 整个任务自己从调研到实现大概花了两周时间, 其中一周卡在了视频编解码上面. 最后项目上面也没应用上. 因此开源了这个<a href="https://github.com/EvanLyu732/iceoryx-v4l2-yuyv2bgr-camera">仓库</a>, 算是给近期比较有意思需求的一个方案. 这篇文章将一步步的介绍并解决这个问题.</p>
<h1 id="ji-yu-v4l2de-xiang-ji-qu-dong-shi-xian-liu-cheng">基于V4l2的相机驱动实现流程</h1>
<p>首先, 旧版的相机驱动是基于v4l2的. v4l2就是linux提供的一系列api. 基于v4l2开发的驱动也是有一个比较固定的流程的. 大体如下:</p>
<pre style="background-color:#eff1f5;color:#4f5b66;"><code><span>1. 打开相机获得句柄
</span><span>2. 准备好v4l2_buffer并且配置v4l2_buffer
</span><span>3. 等待句柄事件触发
</span><span>4. 事件触发后访问v4l2_buffer存的就是准备好的相机buffer(v4l2_struct) 
</span></code></pre>
<p>此外相机是在硬件buffer里获取, 需要让用户态程序能够访问有三种方式dma, mmap和userptr. 我们希望尽可能低的cpu使用率因此选择dma. 因为其他两种方式相比, 从用户态程序操作buffer是直接对硬件buffer做操作 .而mmap和userptr都是对虚拟地址做操作的, 因此视频转码之后需要多一步I/O拷贝的硬件buffer.</p>
<p>了解了相机驱动大体流程之后, 首先先是尝试了<code>v4l2_open()</code>与<code>open()</code>, <code>v4l2_ioctl()</code>与<code>ioctl()</code>这些系统api的替换, 观察是否能有优化的效果. 经过一番尝试后发送如果换成<code>v4l2_open()</code>都无法打开用<code>open()</code>能打开的句柄.</p>
<h1 id="tu-xiang-zhuan-ma">图像转码</h1>
<p>因为我们的平台是Jetson Orin. 自然会去想使用Nvidia提供的一些硬件视频编解码或者其他工具链路来完成, 比较直观的想法是在gpu上做yuyv到bgr的转换, 或者能直接在硬件buffer里面完成转码肯定是最好的. 所以先尝试了能否在硬件上直接做转码. 就开始了解Nv的工具链, Jetson Pack等等. 当然也会在Nv的论坛上看别人的post, 最开始看回答的时候也有些云里雾里的. 还有很多时候明明也没有解决方案，Nv也会把帖子标为solved. 当然这里不会过多论述踩坑的过程, 比较有帮助是下面这张图, 这张图展示了Nv的生态工具链：</p>
<p><img src="https://raw.githubusercontent.com/EvanLyu732/evanlyu732.github.io/main/static/images/nv.png" alt="nvtoolkts" /></p>
<p>ok, 明确了大体上Nv所提供的工具链之后, 接下来解决这一步的问题: 原始相机吐出来的格式是YUYV要转换成BGR24, 在这一过程要达到性能最优.</p>
<p>根据上面的需求尝试了以下几个方案:</p>
<ol>
<li>基于硬件的编解码，基于JetPack 5使用nvbuf_utils的NvBufSurface来存储相机原始数据buffer, 再使用NvBufSurfaceTransform</li>
<li>基于cuda做手动的转码,手写kernel. 根据这个<a href="https://en.wikipedia.org/wiki/Y%E2%80%B2UV">公式</a>, 一组YUYV可以转成成2个BGR像素. 以及jetson_multimedia_api的samples里面的转rgb的<a href="https://github.com/EvanLyu732/jetson_multimedia_api/blob/main/samples/v4l2cuda/yuv2rgb.cu">例子</a>.</li>
<li>使用cuda加速版的opencv的cvtColor</li>
<li>使用<a href="https://developer.nvidia.com/npp">Npp</a>来做处理</li>
</ol>
<p>尝试之后发现:
方案1: 硬件只能转换成BGRA, 因此要从BGRA转换成BGR的话. 不可避免的就需要在用户态开辟buffer做转换. 过程比较繁琐.
方案3: 性能相比于方案2要差, 猜测原因是cuda opencv不能自定义threads和block的比例.
方案4: 有奇怪的bug. 转出来的图片不符合预期，也没有论坛post去讨论这个问题. 因时间原因, 解不了只好放弃.</p>
<p>这一步最终选择了方案二. 使用CUDA Zero Copy Mapped Memory(host mem与device mem映射), 然后使用核函数去做转换.</p>
<h1 id="shi-jian-chuo-dui-qi">时间戳对齐</h1>
<p>相机驱动输出的结构体是<code>v4l2_struct</code>. 而<code>v4l2_struct</code>带的timestamp是相对时间戳（从系统上电开始计时）并且是Start Of Frame(即buffer里面第一个字节有数据时的时间),而需要转换到unix时间戳。那如何做转换呢? 通过<code>clock_gettime</code>函数里面, 传入两个<code>timespec</code>.一个为<code>realtime</code>另一个为<code>monotonic</code>. 再做差值就是两个尺度原点的差值. 此外, 还需要加RTCPU与CPU时间戳的偏移量(见<a href="https://developer.ridgerun.com/wiki/index.php/NVIDIA_Jetson_TX2_-_VI_Latency_Measurement_Techniques">链接</a>):</p>
<p><code>t0 = adjusted_sof = TSC - offset_ns </code></p>
<p><code>TSC</code>即下图的<code>t1</code>, 其中<code>offset_ns</code>代表<code>latency</code>.</p>
<p><img src="https://github.com/EvanLyu732/evanlyu732.github.io/blob/main/static/images/SOF-latency-path.png?raw=true" alt="sof-latency-path" /></p>
<p>再补偿回这个偏移量就可以得到尺度一样的时间戳. 如果是在Nv的板上的话，偏移量会存放在<code>/sys/devices/system/clocksource/clocksource0/offset_ns</code>这个路径下. 加上了这个偏移量那输出的就是<code>monotonic_time</code>.</p>
<h1 id="ben-ji-ipc-inter-process-communication">本机IPC(Inter Process Communication)</h1>
<p>在编解码这一步我们使用了cuda开辟了gpu内存, 所以如果能基于cuda_ipc的话应该是最优解(没有多余的拷贝，客户端应用程序可以直接指向gpu buffer). 但是使用cuda-ipc的话就不能使用device和host memory的映射, 必须要<code>cudaMemcpy</code>. 并且我们希望cpu应用端也能直接拿. 接下来就考虑使用shared memory或者传dma_fd. 理论上传dma_fd的性能更高, 但是也依赖Nv的JetPack, 而刚好我们的JetPack版本在2023年12月这个时间点还不支持共享NvBufSurface. 如果以后支持了, 使用<code>NvBufferTransformEx()</code>类似这样的api应该是最优的做法. 
还有, 可以用<code>eglstream</code>去做IPC, 比较麻烦的是每多一个订阅者就要改一次代码(开通channel). 因此也排除了基于Nv的生态做IPC.</p>
<p>现在考虑使用shared memory去做这件事. 有一个问题就是在应用端（驱动）去往内存块里写图片的时候, 客户端需要用进程锁. 如果这时候同步机制做的不好的话, 就很容易出问题. 一开始尝试使用boost的interprocess读写锁, 但是这里还是有内核态到用户态之间的切换. 基于纯用户态的话, 使用信号量做触发机制. 这样做是可行的, 但是对客户端接受编写接受图像代码逻辑有要求. 但还是有个问题就是这套机制没办法自定义QOS, 并且只限定于这种场景. </p>
<p>于是最终转向了<a href="https://github.com/eclipse-iceoryx/iceoryx">Iceoryx</a>. 因为这也是现有的基于shared memory(c++)最成熟的中间件. 相比于手写shared memory, 基于Iceoryx的通用性和可复用程序更高, 更有利于后续其他模块满足迁移通信机制的需求.</p>
<h2 id="jie-guo">结果</h2>
<p>做完上述处理过后的驱动相比于供应商提供给我们的驱动在cpu使用率在JetSon Orin上降低了10%左右. 如果你也有类似的问题, 参考这个<a href="https://github.com/EvanLyu732/iceoryx-v4l2-yuyv2bgr-camera">仓库</a>或许对你有所帮助.</p>
<h2 id="zong-jie">总结</h2>
<p>整个过程有以下几点总结:</p>
<ol>
<li>Nv的很多资料散落在论坛里面，需要多个post才能拼成一个完整的信息源.</li>
<li>问题最快的解决方式是直接让供应商找人去改. 能有时间和精力去研究这些当然好, 写完这篇文章或许能证明自己的一些学习能力. 但是所有问题的最快解决方案始终是找到对应的人. 因为很多问题遇到一次基本上也不会遇到第二次了, 很难说能从获得系统性的思考能力.</li>
<li>如果在现有的Nv板上在官方文档找不到解决问题的资料, 不妨往以前版本的Nv板的官方资料上面找.</li>
</ol>
<h2 id="can-kao-zi-liao">参考资料</h2>
<p>以下是在这过程中比较有帮助的参考资料:</p>
<ul>
<li>https://developer.ridgerun.com/wiki/index.php/NVIDIA_Jetson_TX2_-_Video_Input_Timing_Concepts</li>
<li>https://forums.developer.nvidia.com/t/interprocess-zero-copy-image-transfer/231623</li>
<li>https://on-demand.gputechconf.com/gtc/2016/webinar/getting-started-jetpack-camera-api.pdf</li>
</ul>

            
        </div>
        <div class="post-meta">
            
                


二〇二三年十二月二十日

            
        </div>
    </article>
    
    <article class="post">
        <div class="post-title"><a href="https:&#x2F;&#x2F;evanlyu732.github.io&#x2F;blog3&#x2F;" class="post-title-link">发展思考的方式</a></div>
        <div class="post-content">
            
                <p><em>这是一篇读书摘要汇总(&quot;The Art of Doing Science and Engineering: Learning to Learn&quot;)</em></p>
<p>写这篇文章的灵感来自于之前读<a href="https://en.wikipedia.org/wiki/Richard_Hamming">Richard Hamming</a>的<a href="https://www.amazon.com/Art-Doing-Science-Engineering-Learning/dp/1732265178">&quot;The Art of Doing Science and Engineering: Learning to Learn&quot;</a>. 书的内容来自于他给美国海军的一系列讲座集合, 之后整理成书. 书中Hamming有非常多精彩的观点,但是看书有一个问题就是到最后很难提炼成自己的东西, 所以这种好书就需要时间去吸收, 看完不是结束, 而是行动的开始. 这里选取了十五句本书对我最有影响的话.</p>
<p>Quote1. </p>
<blockquote>
<p>“In science, if you know what you are doing, you should not be doing it.
In engineering, if you do not know what you are doing, you should not be doing it.” - P49</p>
</blockquote>
<p>工程和科学应该有清晰界定的范围, 对于实现工程, 很多时候会参杂着research. 但是要界定research的范围. 应该是在已知面(不应跳进未知领域的坑) 进行探索. 此外, 在工程中未知因素越多, 出问题可能性越大, 应当越简洁越好.</p>
<p>Quote2. </p>
<blockquote>
<p>“I believe the best predictions are based on understanding the fundamental forces involved, and this is what I depend on mainly.” - P51</p>
</blockquote>
<p>技术和时代变化如此剧烈的现在, 更应该总结和思考什么是基础因素. </p>
<p>Quote3. </p>
<blockquote>
<p>“ so long as it takes you to greatness, is none of my business. You must, as in the case of forging your personal style, find your vision of your future career, and then follow it as best you can.
No vision, not much of a future.” - P56</p>
</blockquote>
<p>尝试制定并不断修正自己的计划. 才能让未来尽可能的与计划相接近.</p>
<p>Quote4. </p>
<blockquote>
<p>“The people at the bottom do not have the larger, global view, but at the top they do not have the local view of all the details, many of which can often be very important, so either extreme gets poor results.” - P77</p>
</blockquote>
<p>底层视野(执行层)和顶层视野(规划层)都很重要. 盲目的只注重哪一个方面都不会有好结果.</p>
<p>Quote5. </p>
<blockquote>
<p>“I suggest you must rethink everything you ever learned on the subject, question every successful doctrine from the past, and finally decide for yourself its future applicability. The Buddha told his disciples, “Believe nothing, no matter where you read it, or who said it, no matter if I have said it, unless it agrees with your own reason and your own common sense.” I say the same to you—you must assume the responsibility for what you believe.” - P82</p>
</blockquote>
<p>批判性思维, 足够清晰的了解问题才能最好的解决问题. 清晰的了解问题必须要经过独立思考的这个过程.</p>
<p>Quote6. </p>
<blockquote>
<p>“Mathematics is the language of clear thinking.” - P625</p>
</blockquote>
<p>下一次遇到了不清晰的问题可以尝试用数学的方式描述出来.</p>
<p>Quote7. </p>
<blockquote>
<p>“What you did to become successful is likely to be counterproductive when applied at a later date.” - P713</p>
</blockquote>
<p>不断的反思过去的行为, 然后加以学习总结以及改正.</p>
<p>Quote8. </p>
<blockquote>
<p>“If you optimize the components, you will probably ruin the system performance.” - P752</p>
</blockquote>
<p>部分最优不代表系统最优, 系统工程学的观点. 吴军也讲到过.</p>
<p>Quote9. </p>
<blockquote>
<p>“You get what you measure” - Chapter29 Title</p>
</blockquote>
<p>生活无法在没有指标的方面取得进步.</p>
<p>Quote10. </p>
<blockquote>
<p>“In planning to change yourself clearly, the old Greek saying applies: “Know thyself.” And do not try heroic reformations which are almost certain to fail. Practice on small ones until you gradually build up your ability to change yourself in the larger things. You must learn to walk before you run in this matter of being creative, but I believe it can be done.”</p>
</blockquote>
<p>改变是从非常微小且具体的步骤开始.</p>
<p>Quote11. </p>
<blockquote>
<p>“Why are you not working on and thinking about the important problems in your area?” If you do not work on important problems, then it is obvious you have little chance of doing important things.” - P808</p>
</blockquote>
<p>只有在重要的领域研究重要的问题才能取得重要的结果.</p>
<p>Quote12. </p>
<blockquote>
<p>“intellectual investment is like compound interest: the more you do, the more you learn how to do, so the more you can do, etc”</p>
</blockquote>
<p>掌握尽可能多的问题模型, 收益会体现在以后的问题上面.</p>
<p>Quote13. </p>
<blockquote>
<p>“There is another trait of great people I must talk about—and it took me a long time to realize it. Great people can tolerate ambiguity; they can both believe and disbelieve at the same time. You must be able to believe your organization and field of research is the best there is, but also that there is much room for improvement! You can sort of see why this is a necessary trait. If you believe too much, you will not likely see the chances for significant improvements; if you do not believe enough, you will be filled with doubts and get very little done, chances are only the 2%, 5%, and 10% improvements.”</p>
</blockquote>
<p>辩证思考, 至少需要同时看待事物的两个方面.</p>
<p>Quote14. </p>
<blockquote>
<p>“All three are essential—you must learn to sell your ideas, not by propaganda, but by force of clear presentation. I am sorry to have to point this out; many scientists and others think good ideas will win out automatically and need not be carefully presented. They are wrong; many a good idea has had to be rediscovered because it was not well presented the first time, years before! New ideas are automatically resisted by the establishment, and to some extent justly.” - P822</p>
</blockquote>
<p>清晰的表达比单纯只拥有一个好的点子更加重要.</p>
<p>Quote15. </p>
<blockquote>
<p>“I believe it is—the chief gain is in the effort to change yourself, in the struggle with yourself, and it is less in the winning than you might expect. Yes, it is nice to end up where you wanted to be, but the person you are when you get there is far more important.”</p>
</blockquote>
<p>相信并且观察和体会内在的变化.</p>

            
        </div>
        <div class="post-meta">
            
                


二〇二三年十二月九日

            
        </div>
    </article>
    
    <article class="post">
        <div class="post-title"><a href="https:&#x2F;&#x2F;evanlyu732.github.io&#x2F;blog2&#x2F;" class="post-title-link">积极不干预</a></div>
        <div class="post-content">
            
                <p>如果在各大搜索网站上,搜索”积极不干预“. 那么搜索结果第一条一定是香港政府为了振兴经济所提出的<a href="https://zh.wikipedia.org/zh-cn/%E7%A9%8D%E6%A5%B5%E4%B8%8D%E5%B9%B2%E9%A0%90">&quot;积极不干预政策&quot;</a>. 点击高亮的字, 会进入维基百科官方的解释. 如果打开不方便的话, 这里将粘贴维基百科的一段内容.</p>
<blockquote>
<p>有学者认为, <strong>积极不干预应理解作“积极性”的不干预. 积极不干预意味基本上是要干预的; 若不干预, 必须要有正面而积极性的效果</strong>. 并指出, “港英年代的经济哲学一向是 <strong>最大的支持, 最小的干预</strong>. (maximum support，minimum intervention) ” - wiki</p>
</blockquote>
<p>&quot;不干预&quot;好理解, 那么&quot;积极&quot;是什么意思呢? 实际上在看完维基百科的词条之后, 我还是不明白&quot;积极&quot;在这个语境里是什么意思. 之所以兴起而发写这篇文章的原因是因为某日在网上刷到一个视频, 标题叫<a href="https://www.youtube.com/watch?v=K6i2z-t5bmo">&quot;谷德昭 溝通能力 即時增值&quot;</a>, 如标题所写, 这是一个关于沟通能力提升的视频. 相信如果不是资深一点的影迷, 应该是不会知道<a href="https://zh.wikipedia.org/wiki/%E8%B0%B7%E5%BE%B7%E6%98%AD">谷德昭</a>这个人. 而且因为是香港人, 所以是用的粤语演讲. 这让不懂粤语的朋友更难看完整个视频. 况且关于沟通能力如何提升, 经典的资料比比皆是. 无非就是一些普遍的大道理, 大同小异. 那谷德昭又讲了什么呢? 整个视频我是没快进着看的, 最开始谷德昭讲的都是普遍性的道理. 直到他谈到了 <strong>&quot;积极不干预&quot;</strong>.  他用政府的政策来类比与人沟通的方式. 道理也普通, 简单而言之就是抱着最&quot;积极&quot;的心态去沟通. 和&quot;尽人事然后听天意&quot;意思很类似. 但是态度不一样. <strong>&quot;积极不干预&quot;</strong> 指的是做好自己该做的部分, <span style="color:green"> <strong>然后用最积极的心态去想这件事</strong>. </span> 积极的心态绝不是欺骗, 更多的是不活在&quot;想象陷阱&quot;当中. 往往很多时候, 我们是怕往前迈出一步就会跌掉. 在国际形势逐渐复杂的今日和信息过载的时代背景下, 能够保持这种心态的能力绝不是自然形成, 而是需要不断练习.</p>
<p>那么如果放在人际交往或者做事的角度上讲的话, 上面这句引用可以解读成这样:</p>
<blockquote>
<p><strong>积极不干预应理解作“积极性”的不干预. 积极不干预意味必须积极的做事; 若不干预, 必须要有正面而积极性的心态</strong>.  <strong>最大的努力, 最小的负面情绪</strong>. (maximum effort，minimum negative mindset)” - wiki</p>
</blockquote>
<p>共勉.</p>

            
        </div>
        <div class="post-meta">
            
                


二〇二三年十月八日

            
        </div>
    </article>
    

</section>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script>
        var Home = location.href,
        xhr,
        xhrUrl = '';
    
        var Diaspora = {
            L: function(url, f, err) {
                if (url == xhrUrl) {
                    return false;
                }
                xhrUrl = url;
                if (xhr) {
                    xhr.abort();
                }
                xhr = $.ajax({
                    type: 'GET',
                    url: url,
                    timeout: 10000,
                    success: function(data) {
                        f(data);
                        xhrUrl = '';
                    },
                    error: function(a, b, c) {
                        if (b == 'abort') {
                            err && err()
                        } else {
                            window.location.href = url;
                        }
                        xhrUrl = '';
                    }
                });
            },
            loading: function() {
                var w = window.innerWidth;
                var css = '<style class="loaderstyle" id="loaderstyle'+ w +'">'+
                    '@-moz-keyframes loader'+ w +'{100%{background-position:'+ w +'px 0}}'+
                    '@-webkit-keyframes loader'+ w +'{100%{background-position:'+ w +'px 0}}'+
                    '.loader'+ w +'{-webkit-animation:loader'+ w +' 3s linear infinite;-moz-animation:loader'+ w +' 3s linear infinite;}'+
                    '</style>';
                $('.loaderstyle').remove()
                $('head').append(css)
                $('#loader').removeClass().addClass('loader'+ w).show()
            },
            loaded: function() {
                $('#loader').removeClass().hide()
            }
        };
    
        $(function() {
            $('body').on('click', function(e) {
                var tag = $(e.target).attr('class') || '',
                    rel = $(e.target).attr('rel') || '';
                if (!tag && !rel) return;
                switch (true) {
                    // next page
                    case (tag.indexOf('more') != -1):
                        tag = $('.more');
                        if (tag.data('status') == 'loading') {
                            return false
                        }
                        var num = parseInt(tag.data('page')) || 1;
                        if (num == 1) {
                            tag.data('page', 1)
                        }
                        tag.html("旧文").data('status', 'loading')
                        Diaspora.loading()
                        Diaspora.L(tag.attr('href'), function(data) {
                            tag.hide();
                            $('.license').hide();
                            var link = $(data).find('.more').attr('href');
                            if (link) {
                                tag.attr('href', link).html("旧文").data('status', 'loaded')
                                tag.data('page', parseInt(tag.data('page')) + 1)
                            }

                            var tempScrollTop = $(window).scrollTop();
                            $('body').append($(data).find('.posts'))
                            $(window).scrollTop(tempScrollTop + 100);
                            Diaspora.loaded()
                            //$('html,body').animate({ scrollTop: tempScrollTop + 400 }, 500);
                            if (link !== '/' && link != '') {
                                $('body').append($(data).find('.page-nav'))
                            }
                        }, function() {
                            tag.html("旧文").data('status', 'loaded')
                        })
                        return false;
                        break;
                    default:
                        return true;
                        break;
                }
            });
        })
    </script>
    
    <nav class="page-nav">
      <a href="https:&#x2F;&#x2F;evanlyu732.github.io&#x2F;page&#x2F;10&#x2F;" class="more">旧文</a>
    </nav>


    </main>
    
    <p class="license"></p>
    
</body>
</html>
